<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REACT Ground Control Station - Satellite Map</title>
    
    <!-- Leaflet CSS (local) -->
    <link rel="stylesheet" href="/static/leaflet/leaflet.css" />
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        
        #map {
            height: 100vh;
            width: 100%;
            pointer-events: auto; /* Ensure map can receive mouse events */
            touch-action: none; /* For better touch handling in QtWebEngine */
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px; /* Position at top right */
            z-index: 1000;
            display: flex;
            flex-direction: column; /* Vertical layout */
            align-items: flex-start;
            gap: 5px; /* Small gap between elements */
        }
        
        .map-controls select, .map-controls button {
            margin: 0;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            font-size: 13px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            min-width: 120px; /* Consistent width */
        }
        
        .map-controls button:hover {
            background: #f0f0f0;
        }
        
        .map-controls select:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="map-controls">
        <button onclick="fitAllUAVs()">Fit All UAVs</button>
        <select id="mapTypeSelect">
            <option value="osm" selected>Street Map</option>
            <option value="satellite">Satellite</option>
            <option value="hybrid">Hybrid</option>
        </select>
    </div>
    
    <div id="map"></div>

    <!-- Qt WebChannel Script (conditionally loaded) -->
    <script>
        // Try to load Qt WebChannel if available
        try {
            const script = document.createElement('script');
            script.src = 'qrc:///qtwebchannel/qwebchannel.js';
            script.onerror = () => console.log('Qt WebChannel not available');
            document.head.appendChild(script);
        } catch (e) {
            console.log('Qt WebChannel not available');
        }
    </script>
    
    <!-- Leaflet JavaScript (local) -->
    <script src="/static/leaflet/leaflet.js"></script>
    
    <script>
        console.log('REACT satellite_map.html JavaScript loaded');
        console.log('Starting REACT satellite map...');
        
        let map;
        let uavMarkers = {};
        let qtChannel = null;
        let qtBridge = null;
        
        // Map layer definitions - now using same origin!
        let mapLayers = {};
        
        function initMapLayers() {
            if (typeof L === 'undefined') {
                console.error('Leaflet not available');
                return false;
            }
            
            // Load config from backend
            const currentOrigin = window.location.origin;
            return fetch(currentOrigin + '/api/config')
                .then(response => response.json())
                .then(config => {
                    const streetTransparency = config.map?.street_transparency || 0.5;
                    
                    // Same-origin tiles (cache-first for offline)
                    mapLayers = {
                        osm: L.tileLayer(currentOrigin + '/tiles/openstreetmap/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '¬© OpenStreetMap contributors',
                            errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=='
                        }),
                        
                        satellite: L.tileLayer(currentOrigin + '/tiles/satellite/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: 'Google Satellite via Local Cache',
                            updateWhenIdle: false,
                            updateWhenZooming: true,
                            keepBuffer: 2,
                            errorTileUrl: currentOrigin + '/blank_tile.png',
                            getTileUrl: function(coords) {
                                const url = currentOrigin + `/tiles/satellite/${coords.z}/${coords.x}/${coords.y}.png`;
                                console.log('Requesting satellite tile:', url);
                                return url;
                            }
                        }),
                        
                        hybrid: L.layerGroup([
                            L.tileLayer(currentOrigin + '/tiles/satellite/{z}/{x}/{y}.png', {
                                maxZoom: 19,
                                attribution: 'Google Satellite via Local Cache',
                                errorTileUrl: currentOrigin + '/blank_tile.png'
                            }),
                            L.tileLayer(currentOrigin + '/tiles/openstreetmap/{z}/{x}/{y}.png', {
                                maxZoom: 19,
                                attribution: '¬© OpenStreetMap contributors',
                                opacity: streetTransparency,
                                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=='
                            })
                        ])
                    };
                    
                    return true;
                })
                .catch(error => {
                    console.error('Error loading config:', error);
                    // Fallback without config (offline mode)
                    const currentOrigin = window.location.origin;
                    mapLayers = {
                        osm: L.tileLayer(currentOrigin + '/tiles/openstreetmap/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '¬© OpenStreetMap contributors',
                            errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=='
                        }),
                        
                        satellite: L.tileLayer(currentOrigin + '/tiles/satellite/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: 'Google Satellite via Local Cache',
                            updateWhenIdle: false,
                            updateWhenZooming: true,
                            keepBuffer: 2,
                            errorTileUrl: currentOrigin + '/blank_tile.png',
                            getTileUrl: function(coords) {
                                const url = currentOrigin + `/tiles/satellite/${coords.z}/${coords.x}/${coords.y}.png`;
                                console.log('Requesting satellite tile:', url);
                                return url;
                            }
                        }),
                        
                        hybrid: L.layerGroup([
                            L.tileLayer(currentOrigin + '/tiles/satellite/{z}/{x}/{y}.png', {
                                maxZoom: 19,
                                attribution: 'Google Satellite via Local Cache',
                                errorTileUrl: currentOrigin + '/blank_tile.png'
                            }),
                            L.tileLayer(currentOrigin + '/tiles/openstreetmap/{z}/{x}/{y}.png', {
                                maxZoom: 19,
                                attribution: '¬© OpenStreetMap contributors',
                                opacity: 0.5,
                                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=='
                            })
                        ])
                    };
                    return true;
                });
        }
        
        async function initMap() {
            if (typeof L === 'undefined') {
                console.error('Error: Leaflet not loaded');
                return;
            }
            
            console.log('Initializing map...');
            
            try {
                const layersReady = await initMapLayers();
                if (!layersReady) {
                    console.error('Error: Could not initialize layers');
                    return;
                }
            } catch (error) {
                console.error('Error initializing layers:', error);
                return;
            }
            
            // Fetch default home position from server (with offline fallback)
            const currentOrigin = window.location.origin;
            const apiUrl = currentOrigin + '/api/info?t=' + Date.now(); // Cache-busting
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('API info received:', data);
                    console.log('Default home from API:', data.default_home_position);
                    const homePos = data.default_home_position || {
                        latitude: 40.7128,
                        longitude: -76.006,
                        zoom: 12
                    };
                    console.log('Using home position:', homePos);
                    
                    initMapWithPosition(homePos);
                })
                .catch(error => {
                    console.warn('Failed to get default home position (offline mode?):', error);
                    // Offline fallback to configured position
                    const fallbackPos = {
                        latitude: 40.7128,
                        longitude: -76.006,
                        zoom: 12
                    };
                    console.log('Using offline fallback position:', fallbackPos);
                    initMapWithPosition(fallbackPos);
                });
        }
        
        function initMapWithPosition(homePos) {
            try {
                // Create map centered on configured home position with explicit interaction options
                map = L.map('map', {
                    center: [homePos.latitude, homePos.longitude],
                    zoom: homePos.zoom,
                    dragging: true,
                    touchZoom: true,
                    doubleClickZoom: true,
                    scrollWheelZoom: true,
                    boxZoom: true,
                    keyboard: true,
                    zoomControl: true,
                    attributionControl: true
                });
                
                // Load config to get default layer (with offline fallback)
                const currentOrigin = window.location.origin;
                fetch(currentOrigin + '/api/config')
                    .then(response => response.json())
                    .then(config => {
                        const defaultLayer = config.map?.default_layer || 'satellite';
                        console.log('Config loaded, default layer:', defaultLayer);
                        if (mapLayers[defaultLayer]) {
                            mapLayers[defaultLayer].addTo(map);
                            currentLayer = mapLayers[defaultLayer];
                            console.log('Started with default layer:', defaultLayer);
                        } else {
                            mapLayers.satellite.addTo(map);
                            currentLayer = mapLayers.satellite;
                            console.log('Fallback to satellite layer');
                        }
                    })
                    .catch(error => {
                        console.warn('Could not load config (offline mode?), using satellite layer:', error);
                        // Offline fallback to satellite
                        mapLayers.satellite.addTo(map);
                        currentLayer = mapLayers.satellite;
                        console.log('Offline mode - using satellite layer');
                    });
                
                console.log(`Map initialized at ${homePos.latitude}, ${homePos.longitude} with zoom ${homePos.zoom}`);
                
                // Add a test UAV marker at home position
                const uavIcon = L.divIcon({
                    html: 'üöÅ',
                    className: 'uav-icon',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                const testUAV = L.marker([homePos.latitude, homePos.longitude], {icon: uavIcon})
                    .addTo(map)
                    .bindPopup('TEST UAV<br/>Status: Active');
                    
                uavMarkers['TEST_UAV'] = testUAV;
                
                // Set up map type selector
                const mapTypeSelect = document.getElementById('mapTypeSelect');
                mapTypeSelect.addEventListener('change', function() {
                    changeMapType(this.value);
                });
                
                // Test tile loading
                testTileServer();
                
                // Add debug logging for map events
                map.on('movestart', function(e) {
                    console.log('Map move started');
                });
                
                map.on('move', function(e) {
                    console.log('Map is moving, center:', map.getCenter());
                });
                
                map.on('moveend', function(e) {
                    console.log('Map move ended, center:', map.getCenter(), 'zoom:', map.getZoom());
                });
                
                map.on('drag', function(e) {
                    console.log('Map drag event');
                });
                
                map.on('zoomstart', function(e) {
                    console.log('Zoom started');
                });
                
                map.on('zoomend', function(e) {
                    console.log('Zoom ended, level:', map.getZoom());
                });

                // Add tile loading debug
                map.on('tileloadstart', function(e) {
                    console.log('Tile load start:', e.coords);
                });
                
                map.on('tileload', function(e) {
                    console.log('Tile loaded:', e.coords);
                });
                
                map.on('tileerror', function(e) {
                    console.error('Tile error:', e.coords, e.error);
                });

            } catch (error) {
                console.error('Map initialization error:', error);
            }
        }
        
        let currentLayer = null;
        
        function changeMapType(mapType) {
            console.log('Changing map type to:', mapType);
            if (mapLayers[mapType]) {
                if (currentLayer) {
                    map.removeLayer(currentLayer);
                }
                currentLayer = mapLayers[mapType];
                map.addLayer(currentLayer);
                console.log('Map layer changed to:', mapType);
            } else {
                console.error('Map type not found:', mapType);
            }
        }
        
        function testTileServer() {
            const currentOrigin = window.location.origin;
            
            // Test API endpoint
            fetch(currentOrigin + '/api/info')
                .then(response => response.json())
                .then(data => {
                    console.log('API connected successfully');
                    console.log('API info:', data);
                })
                .catch(error => {
                    console.error('API connection failed: ' + error.message);
                });
                
            // Test tile endpoint
            fetch(currentOrigin + '/tiles/satellite/0/0/0.png')
                .then(response => {
                    if (response.ok) {
                        console.log('Satellite tiles: Available');
                    } else {
                        console.error('Satellite tiles: HTTP ' + response.status);
                    }
                })
                .catch(error => {
                    console.error('Satellite tiles: ' + error.message);
                });
        }
        
        function fitAllUAVs() {
            const group = new L.featureGroup(Object.values(uavMarkers));
            if (group.getLayers().length > 0) {
                map.fitBounds(group.getBounds(), {padding: [20, 20]});
            }
        }
        
        // Wait for Leaflet to load, then initialize
        function waitForLeaflet() {
            if (typeof L !== 'undefined') {
                console.log('Leaflet loaded, initializing map...');
                initMap();
            } else {
                console.log('Waiting for Leaflet to load...');
                setTimeout(waitForLeaflet, 100);
            }
        }
        
        // Start when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, waiting for Leaflet...');
            console.log('Loading Leaflet...');
            waitForLeaflet();
        });
        
        // Qt WebChannel integration (if available)
        setTimeout(() => {
            if (typeof QWebChannel !== 'undefined') {
                console.log('QWebChannel available, setting up Qt bridge...');
                // Initialize Qt communication here if needed
            }
        }, 1000);
    </script>
</body>
</html>